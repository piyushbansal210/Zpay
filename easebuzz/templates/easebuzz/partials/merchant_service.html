<div class="container-fluid mt-3 px-3">
  <!-- ====== PAGE HEADER ====== -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h4 class="fw-semibold mb-0 text-dark">Merchant Service</h4>
    <div class="input-group" style="max-width: 260px;">
      <input id="searchBox" type="text" class="form-control form-control-sm border-end-0" placeholder="Search Merchant ID / Name">
      <span class="input-group-text bg-white border-start-0"><i class="bi bi-search"></i></span>
    </div>
  </div>

  <!-- ====== MAIN CARD ====== -->
  <div class="card border-0 shadow-sm rounded-3">
    <div class="card-body p-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="fw-semibold text-dark mb-0">Add Service</h6>
      </div>

      <!-- ====== TABLE ====== -->
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead class="bg-light text-muted small border-bottom">
            <tr>
              <th>Merchant</th>
              <th>Business Name</th>
              <th class="text-center">Auth</th>
              <th class="text-center">Payin</th>
              <th class="text-center">Payout</th>
              <th class="text-center">Action</th>
            </tr>
          </thead>
          <tbody id="merchantTableBody">
            <tr>
              <td colspan="6" class="text-center text-muted py-4">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                Loading merchant data...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ====== PAGINATION ====== -->
      <div class="d-flex justify-content-end align-items-center mt-3">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item disabled"><a class="page-link" href="#">&laquo;</a></li>
          <li class="page-item active"><a class="page-link border-0 bg-primary text-white" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">&raquo;</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ========== STYLES ========== -->
<style>
  body { background-color: #f8f9fc !important; }
  .card { border-radius: 12px; }
  .badge { font-size: 0.75rem; padding: 5px 10px; border-radius: 6px; }
  .btn-refresh { font-size: 0.75rem; }
</style>

<!-- ========== SCRIPT ========== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  loadMerchants();

  function loadMerchants() {
    fetch("/easebuzz/list_merchants/")
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById("merchantTableBody");
        tbody.innerHTML = "";
        const merchants = data.merchants || data.data || [];
        if (!merchants.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No merchants found</td></tr>`;
          return;
        }
        merchants.forEach(m => {
          const key = m.merchant_key || "-";
          const name = m.merchant_name || "-";
          tbody.insertAdjacentHTML("beforeend", `
            <tr class="border-bottom">
              <td>${key}</td>
              <td>${name}</td>
              <td class="text-center" id="auth-${key}"><span class="badge bg-light text-secondary">Loading...</span></td>
              <td class="text-center" id="payin-${key}"><span class="badge bg-light text-secondary">Loading...</span></td>
              <td class="text-center" id="payout-${key}"><span class="badge bg-light text-secondary">Loading...</span></td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-primary btn-refresh" onclick="fetchServices('${key}')">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </td>
            </tr>
          `);
          fetchServices(key);
        });
      })
      .catch(() => showToast("Error fetching merchants"));
  }

  window.fetchServices = (merchantKey) => {
    fetch("/easebuzz/merchant/services/", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ sub_merchant_key: merchantKey })
    })
    .then(res => res.json())
    .then(data => {
      const services = data.services || [];
      const map = {};
      services.forEach(s => map[s.service_name.toLowerCase()] = s.status.toLowerCase());
      updateStatus(`auth-${merchantKey}`, map["auth"]);
      updateStatus(`payin-${merchantKey}`, map["payin"]);
      updateStatus(`payout-${merchantKey}`, map["payout"]);
    })
    .catch(() => showToast("Error fetching services for " + merchantKey));
  };

  function updateStatus(id, status) {
    const el = document.getElementById(id);
    if (!el) return;
    let badge = `<span class="badge bg-light text-secondary">Not Added</span>`;
    if (status === "active" || status === "added")
      badge = `<span class="badge bg-success-subtle text-success">Added</span>`;
    else if (status === "inactive" || status === "pending")
      badge = `<span class="badge bg-warning-subtle text-warning">Pending</span>`;
    el.innerHTML = badge;
  }

  function showToast(msg) {
    document.getElementById("toastMsg").innerText = msg;
    new bootstrap.Toast(document.getElementById("liveToast")).show();
  }

  document.getElementById("searchBox").addEventListener("keyup", function() {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("#merchantTableBody tr").forEach(row => {
      row.style.display = row.innerText.toLowerCase().includes(filter) ? "" : "none";
    });
  });
});
</script>

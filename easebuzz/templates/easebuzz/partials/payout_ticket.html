
<div class="container mt-4">
  <h6 class="mb-3">
    Payout / <span class="text-success fw-semibold">Ticket Status</span>
  </h6>

  <!-- Filter Controls -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <div class="btn-group">
      <button id="pendingBtn" class="btn btn-success btn-sm active">Pending</button>
      <button id="closedBtn" class="btn btn-outline-success btn-sm">Closed</button>
    </div>
    <input id="searchInput" type="text" class="form-control form-control-sm w-auto" placeholder="PG Ref / Merchant Ref">
  </div>

  <!-- Table -->
  <div class="card p-3 shadow-sm bg-white rounded">
    <h6 class="fw-semibold mb-2">Ticket Status</h6>
    <table class="table align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Merchant Ref</th>
          <th>PG Ref</th>
          <th>PG Status</th>
          <th>Business Name</th>
          <th>Error Code</th>
          <th>Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="ticketTableBody">
        <tr>
          <td colspan="7" class="text-center text-muted">No entries available</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-center mt-3">
    <nav>
      <ul class="pagination pagination-sm">
        <li class="page-item disabled"><a class="page-link">&lt;</a></li>
        <li class="page-item active"><a class="page-link">1</a></li>
        <li class="page-item disabled"><a class="page-link">&gt;</a></li>
      </ul>
    </nav>
  </div>
</div>

<script>
let currentStatus = "pending";

document.addEventListener("DOMContentLoaded", () => {
  loadTickets();
  document.getElementById("pendingBtn").addEventListener("click", () => switchTab("pending"));
  document.getElementById("closedBtn").addEventListener("click", () => switchTab("closed"));
  document.getElementById("searchInput").addEventListener("keyup", e => {
    if (e.key === "Enter") loadTickets();
  });
});

function switchTab(status) {
  currentStatus = status;
  document.getElementById("pendingBtn").classList.toggle("btn-success", status === "pending");
  document.getElementById("pendingBtn").classList.toggle("btn-outline-success", status !== "pending");
  document.getElementById("closedBtn").classList.toggle("btn-success", status === "closed");
  document.getElementById("closedBtn").classList.toggle("btn-outline-success", status !== "closed");
  loadTickets();
}

function loadTickets() {
  const query = document.getElementById("searchInput").value.trim();
  const url = `/api/payout/ticket_status/?status=${currentStatus}&q=${encodeURIComponent(query)}`;
  const tbody = document.getElementById("ticketTableBody");
  tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      tbody.innerHTML = "";
      if (data.status === 1 && data.tickets.length > 0) {
        data.tickets.forEach(t => {
          tbody.innerHTML += `
            <tr>
              <td>${t.merchant_ref || '-'}</td>
              <td>${t.pg_ref || '-'}</td>
              <td><span class="badge bg-${getStatusColor(t.pg_status)}">${t.pg_status || '-'}</span></td>
              <td>${t.business_name || '-'}</td>
              <td>${t.error_code || '-'}</td>
              <td>${t.amount || '-'}</td>
              <td>
                <button class="btn btn-outline-success btn-sm" onclick="refreshTicket('${t.pg_ref}')">
                  <i class="bi bi-arrow-repeat"></i>
                </button>
              </td>
            </tr>`;
        });
      } else {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No entries available</td></tr>`;
      }
    })
    .catch(err => {
      console.error("Error loading tickets:", err);
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">Error fetching data</td></tr>`;
    });
}

function getStatusColor(status) {
  switch (status?.toLowerCase()) {
    case "success": return "success";
    case "pending": return "warning text-dark";
    case "failed": return "danger";
    default: return "secondary";
  }
}

function refreshTicket(pgRef) {
  alert("Refreshing ticket for PG Ref: " + pgRef);
  // Optional: Call another API endpoint to refresh specific ticket
}
</script>


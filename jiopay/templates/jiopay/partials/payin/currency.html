<div class="page">
  <!-- Page Header -->
  <div class="d-flex align-items-center justify-content-between mb-4">
    <div>
      <h3 class="fw-semibold mb-1" style="color: var(--text);">Payin Currency Management</h3>
      <p class="text-muted mb-0" style="font-size: 0.9rem;">Manage exchange rates and service charges for all supported currencies</p>
    </div>
    <button id="refreshCurrency" class="btn" style="background: var(--accent); border: none; color: var(--accent-ink); border-radius: 10px; padding: 10px 20px; font-weight: 600;">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>





  <!-- Main Card -->
  <div class="card border-0 rounded-4" style="background: var(--bg); border: 1px solid var(--stroke) !important; box-shadow: var(--shadow);">
    <div class="card-body" style="padding: 24px;">
      
      <!-- Search and Filter Section -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="position-relative">
            <i class="bi bi-search position-absolute" style="left: 14px; top: 50%; transform: translateY(-50%); color: var(--muted);"></i>
            <input type="text" id="searchCurrency" class="form-control" placeholder="Search by currency name, symbol or origin..." 
              style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px 10px 40px; background: var(--page);">
          </div>
        </div>
        <div class="col-md-3">
          <select id="filterOrigin" class="form-select" style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--page);">
            <option value="">All Origins</option>
            <option value="India">India</option>
            <option value="USA">USA</option>
            <option value="Europe">Europe</option>
            <option value="Asia">Asia</option>
          </select>
        </div>
        <div class="col-md-3">
          <button id="exportCurrency" class="btn w-100" style="background: transparent; border: 1px solid var(--stroke); color: var(--text); border-radius: 10px; padding: 10px 14px;">
            <i class="bi bi-download"></i> Export to CSV
          </button>
        </div>
      </div>

      <!-- Table -->
      <div class="table-responsive">
        <table class="table align-middle" style="border-collapse: separate; border-spacing: 0;">
          <thead>
            <tr style="background: var(--page); border-radius: 10px;">
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-currency-exchange"></i> Currency Name
                </div>
              </th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">Symbol</th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">Origin</th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-graph-up"></i> Current Rate
                </div>
              </th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-percent"></i> Service Charge
                </div>
              </th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem;">Total Price</th>
              <th style="border: none; padding: 16px; color: var(--muted); font-weight: 600; font-size: 0.875rem; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody id="currencyList">
            <tr>
              <td colspan="7" style="border: none; padding: 60px 20px; text-align: center;">
                <div class="spinner-border" style="color: var(--accent);" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 mb-0" style="color: var(--muted); font-size: 0.9rem;">Fetching currency data...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Empty State (Hidden by default) -->
      <div id="emptyState" class="text-center py-5" style="display: none;">
        <div class="mb-3" style="font-size: 64px; color: var(--muted); opacity: 0.3;">
          <i class="bi bi-currency-exchange"></i>
        </div>
        <h5 class="fw-semibold mb-2" style="color: var(--text);">No Currencies Found</h5>
        <p class="text-muted mb-4" style="font-size: 0.9rem;">There are no currencies matching your search criteria.</p>
        <button onclick="clearFilters()" class="btn" style="background: var(--accent); border: none; color: var(--accent-ink); border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-arrow-clockwise"></i> Clear Filters
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Edit Currency Modal -->
<div class="modal fade" id="editCurrencyModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border: none; border-radius: 14px; box-shadow: var(--shadow);">
      <div class="modal-header" style="border: none; padding: 24px 24px 0;">
        <div>
          <h5 class="fw-semibold mb-1" style="color: var(--text);">Edit Currency</h5>
          <p class="text-muted mb-0" style="font-size: 0.875rem;">Update exchange rate and service charges</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <form id="editCurrencyForm">
          <div class="mb-3">
            <label class="form-label fw-medium" style="color: var(--text); font-size: 0.875rem;">
              <i class="bi bi-currency-exchange me-1"></i> Currency Name
            </label>
            <input type="text" class="form-control" id="currencyName" readonly
              style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--page); cursor: not-allowed;">
          </div>
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label fw-medium" style="color: var(--text); font-size: 0.875rem;">
                <i class="bi bi-cash-stack me-1"></i> Symbol
              </label>
              <input type="text" class="form-control" id="currencySymbol" readonly
                style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--page); cursor: not-allowed;">
            </div>
            <div class="col-md-6">
              <label class="form-label fw-medium" style="color: var(--text); font-size: 0.875rem;">
                <i class="bi bi-geo-alt me-1"></i> Origin
              </label>
              <input type="text" class="form-control" id="currencyOrigin" readonly
                style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--page); cursor: not-allowed;">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium" style="color: var(--text); font-size: 0.875rem;">
              <i class="bi bi-graph-up me-1"></i> Current Rate <span class="text-danger">*</span>
            </label>
            <input type="number" step="0.01" class="form-control" id="currencyRate" required
              style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--bg);">
            <small class="text-muted" style="font-size: 0.8rem;">Exchange rate against base currency</small>
          </div>

          <div class="mb-3">
            <label class="form-label fw-medium" style="color: var(--text); font-size: 0.875rem;">
              <i class="bi bi-percent me-1"></i> Service Charge <span class="text-danger">*</span>
            </label>
            <input type="number" step="0.01" class="form-control" id="serviceCharge" required
              style="border: 1px solid var(--stroke); border-radius: 10px; padding: 10px 14px; background: var(--bg);">
            <small class="text-muted" style="font-size: 0.8rem;">Additional service charge percentage</small>
          </div>

          <!-- Preview Card -->
          <div class="card border-0 rounded-3" style="background: var(--page); padding: 16px; margin-bottom: 16px;">
            <h6 class="fw-semibold mb-2" style="color: var(--text); font-size: 0.875rem;">Preview</h6>
            <div class="d-flex justify-content-between align-items-center">
              <span style="color: var(--muted); font-size: 0.875rem;">Total Price:</span>
              <span class="fw-bold" style="color: var(--accent); font-size: 1.125rem;" id="totalPricePreview">0.00</span>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="border: none; padding: 0 24px 24px;">
        <button type="button" class="btn" data-bs-dismiss="modal" style="background: transparent; border: 1px solid var(--stroke); color: var(--text); border-radius: 10px; padding: 10px 24px;">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn" id="saveCurrency" style="background: var(--accent); border: none; color: var(--accent-ink); border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-check-circle"></i> Save Changes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true" style="display: none; border-radius: 12px; box-shadow: var(--shadow);">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage" style="color: white; font-weight: 500;"></div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
let allCurrencies = [];
let filteredCurrencies = [];

document.addEventListener("DOMContentLoaded", () => {
  loadCurrencies();

  // Event Listeners
  document.getElementById("refreshCurrency").addEventListener("click", loadCurrencies);
  document.getElementById("searchCurrency").addEventListener("input", filterCurrencies);
  document.getElementById("filterOrigin").addEventListener("change", filterCurrencies);
  document.getElementById("exportCurrency").addEventListener("click", exportToCSV);
  
  document.getElementById("saveCurrency").addEventListener("click", saveCurrency);

  // Live preview calculation
  document.getElementById("currencyRate").addEventListener("input", updatePreview);
  document.getElementById("serviceCharge").addEventListener("input", updatePreview);
});

async function loadCurrencies() {
  const tbody = document.getElementById("currencyList");
  const emptyState = document.getElementById("emptyState");
  
  tbody.style.display = "table-row-group";
  emptyState.style.display = "none";
  
  tbody.innerHTML = `
    <tr>
      <td colspan="7" style="border: none; padding: 60px 20px; text-align: center;">
        <div class="spinner-border" style="color: var(--accent);" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 mb-0" style="color: var(--muted); font-size: 0.9rem;">Fetching currency data...</p>
      </td>
    </tr>
  `;

  try {
    const res = await fetch("/api/jiopay/currency_list/");
    const data = await res.json();

    if (!data.currencies || data.currencies.length === 0) {
      tbody.style.display = "none";
      emptyState.style.display = "block";
      updateStats([]);
      return;
    }

    allCurrencies = data.currencies;
    filteredCurrencies = [...allCurrencies];
    renderCurrencies(filteredCurrencies);
    updateStats(filteredCurrencies);

  } catch (err) {
    console.error("Error loading currency list:", err);
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="border: none; padding: 60px 20px; text-align: center;">
          <div style="font-size: 48px; color: #E74C3C; opacity: 0.5; margin-bottom: 16px;">
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <h6 class="fw-semibold mb-2" style="color: var(--text);">Failed to Load Data</h6>
          <p class="text-muted mb-3" style="font-size: 0.9rem;">Unable to fetch currency data. Please try again.</p>
          <button onclick="loadCurrencies()" class="btn" style="background: var(--accent); border: none; color: var(--accent-ink); border-radius: 10px; padding: 8px 20px; font-weight: 600;">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </td>
      </tr>
    `;
  }
}

function renderCurrencies(currencies) {
  const tbody = document.getElementById("currencyList");
  const emptyState = document.getElementById("emptyState");

  if (currencies.length === 0) {
    tbody.style.display = "none";
    emptyState.style.display = "block";
    return;
  }

  tbody.style.display = "table-row-group";
  emptyState.style.display = "none";
  tbody.innerHTML = "";

  currencies.forEach((c, index) => {
    const row = document.createElement("tr");
    row.style.borderBottom = "1px solid var(--stroke)";
    row.style.transition = "background 0.2s ease";
    row.onmouseenter = () => row.style.background = "var(--page)";
    row.onmouseleave = () => row.style.background = "transparent";

    row.innerHTML = `
      <td style="border: none; padding: 16px;">
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--page); border-radius: 10px; font-size: 18px;">
            ${c.symbol || 'ðŸ’±'}
          </div>
          <div>
            <div class="fw-semibold" style="color: var(--text); font-size: 0.9rem;">${c.name}</div>
            <div style="color: var(--muted); font-size: 0.8rem;">Currency</div>
          </div>
        </div>
      </td>
      <td style="border: none; padding: 16px;">
        <span class="badge rounded-pill" style="background: var(--page); color: var(--text); padding: 6px 12px; font-weight: 600; font-size: 0.875rem;">
          ${c.symbol}
        </span>
      </td>
      <td style="border: none; padding: 16px;">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-geo-alt" style="color: var(--muted);"></i>
          <span style="color: var(--text); font-size: 0.875rem;">${c.origin}</span>
        </div>
      </td>
      <td style="border: none; padding: 16px;">
        <span class="fw-semibold" style="color: var(--accent); font-size: 0.9rem;">${parseFloat(c.current_rate).toFixed(2)}</span>
      </td>
      <td style="border: none; padding: 16px;">
        <span class="badge rounded-pill" style="background: #FFF3CD; color: #856404; padding: 6px 12px; font-weight: 600; font-size: 0.875rem;">
          ${parseFloat(c.service_charge).toFixed(2)}%
        </span>
      </td>
      <td style="border: none; padding: 16px;">
        <span class="fw-bold" style="color: var(--text); font-size: 0.9rem;">${parseFloat(c.total_price).toFixed(2)}</span>
      </td>
      <td style="border: none; padding: 16px; text-align: center;">
        <button class="btn btn-sm" onclick='openEditModal(${JSON.stringify(c)})' 
          style="background: var(--accent); border: none; color: var(--accent-ink); border-radius: 8px; padding: 8px 16px; font-weight: 600;">
          <i class="bi bi-pencil-fill"></i> Edit
        </button>
      </td>
    `;

    tbody.appendChild(row);
  });
}

function filterCurrencies() {
  const searchTerm = document.getElementById("searchCurrency").value.toLowerCase();
  const originFilter = document.getElementById("filterOrigin").value;

  filteredCurrencies = allCurrencies.filter(c => {
    const matchesSearch = 
      c.name.toLowerCase().includes(searchTerm) ||
      c.symbol.toLowerCase().includes(searchTerm) ||
      c.origin.toLowerCase().includes(searchTerm);
    
    const matchesOrigin = !originFilter || c.origin === originFilter;

    return matchesSearch && matchesOrigin;
  });

  renderCurrencies(filteredCurrencies);
  updateStats(filteredCurrencies);
}

function clearFilters() {
  document.getElementById("searchCurrency").value = "";
  document.getElementById("filterOrigin").value = "";
  filterCurrencies();
}

function updateStats(currencies) {
  document.getElementById("totalCurrencies").textContent = allCurrencies.length;
  document.getElementById("activeCurrencies").textContent = currencies.length;
  
  const avgRate = currencies.length > 0 
    ? (currencies.reduce((sum, c) => sum + parseFloat(c.current_rate), 0) / currencies.length).toFixed(2)
    : "0.00";
  document.getElementById("avgRate").textContent = avgRate;

  const totalCharge = currencies.length > 0 
    ? (currencies.reduce((sum, c) => sum + parseFloat(c.service_charge), 0)).toFixed(2)
    : "0.00";
  document.getElementById("totalCharge").textContent = totalCharge + "%";
}

function openEditModal(currency) {
  document.getElementById("currencyName").value = currency.name;
  document.getElementById("currencySymbol").value = currency.symbol;
  document.getElementById("currencyOrigin").value = currency.origin;
  document.getElementById("currencyRate").value = parseFloat(currency.current_rate).toFixed(2);
  document.getElementById("serviceCharge").value = parseFloat(currency.service_charge).toFixed(2);
  
  updatePreview();
  
  const modal = new bootstrap.Modal(document.getElementById("editCurrencyModal"));
  modal.show();
}

function updatePreview() {
  const rate = parseFloat(document.getElementById("currencyRate").value) || 0;
  const charge = parseFloat(document.getElementById("serviceCharge").value) || 0;
  const total = rate + (rate * charge / 100);
  document.getElementById("totalPricePreview").textContent = total.toFixed(2);
}

async function saveCurrency() {
  const name = document.getElementById("currencyName").value;
  const rate = document.getElementById("currencyRate").value;
  const charge = document.getElementById("serviceCharge").value;

  if (!rate || !charge) {
    showToast("Please fill in all required fields", "error");
    return;
  }

  const btn = document.getElementById("saveCurrency");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

  try {
    const res = await fetch("/api/jiopay/update_currency/", {
      method: "POST",
      headers: { 
        "Content-Type": "application/json", 
        "X-CSRFToken": getCookie("csrftoken") 
      },
      body: JSON.stringify({ 
        currency: name, 
        rate: parseFloat(rate), 
        service_charge: parseFloat(charge) 
      })
    });
    
    const data = await res.json();
    
    if (data.status === 1 || res.ok) {
      showToast("Currency updated successfully!", "success");
      bootstrap.Modal.getInstance(document.getElementById("editCurrencyModal")).hide();
      setTimeout(() => loadCurrencies(), 500);
    } else {
      showToast(data.message || "Failed to update currency", "error");
    }
  } catch (err) {
    console.error("Error saving currency:", err);
    showToast("Network error. Please try again.", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function exportToCSV() {
  const csvContent = [
    ["Currency Name", "Symbol", "Origin", "Current Rate", "Service Charge", "Total Price"],
    ...filteredCurrencies.map(c => [
      c.name,
      c.symbol,
      c.origin,
      c.current_rate,
      c.service_charge,
      c.total_price
    ])
  ].map(row => row.join(",")).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv" });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `payin_currencies_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  showToast("Currency data exported successfully!", "success");
}

function showToast(message, type = "success") {
  const toast = document.getElementById("toast");
  const toastMessage = document.getElementById("toastMessage");
  
  toastMessage.textContent = message;
  
  if (type === "success") {
    toast.style.background = "linear-gradient(135deg, var(--accent), #9bc963)";
  } else {
    toast.style.background = "linear-gradient(135deg, #E74C3C, #C0392B)";
  }
  
  toast.style.display = "block";
  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<style>
/* Custom form focus styles */
.form-control:focus, .form-select:focus {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 3px rgba(132, 195, 64, 0.1) !important;
}

/* Smooth transitions */
.btn {
  transition: all 0.2s ease;
}

.btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Table hover effect */
tbody tr {
  transition: all 0.2s ease;
}

/* Modal animations */
.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out;
}

/* Toast animation */
#toast {
  animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .table-responsive {
    font-size: 0.875rem;
  }
  
  .card-body {
    padding: 16px !important;
  }
}
</style>